<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Digit Admin Portal</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
	<style>
		html {
			font-family: 'Poppins', Tahoma, Geneva, Verdana, sans-serif;
			background-color: rgb(51, 49, 49);
			color: rgb(207, 205, 194);
			overflow-x: hidden;
		}

		.send {
			display: flex;
			justify-content: center;
			align-items: center;
			height: fit-content;
		}

		input {
			width: 300px;
			height: 30px;
			border: 1px solid black;
			border-radius: 5px;
			padding: 5px;
			margin-right: 10px;
			margin-bottom: 10px;
		}

		button {
			height: 30px;
			border: 1px solid black;
			border-radius: 5px;
			padding: 5px;
			margin-left: 10px;
			align-self: center;
		}

		button .send {
			align-self: normal;
		}

		.message {
			padding: 10px;
			border: 1px solid black;
			border-radius: 5px;
			margin: 10px;
			width: fit-content;
		}

		label,
		.notice {
			font-weight: bold;
			font-size: 12px;
			color: gray;
			margin-bottom: 5px;
			margin-left: 10px;
			margin-right: 10px;
			text-align: center;
		}

		.message-controls {
			border: none;
			background-color: transparent;
			cursor: pointer;
			font-weight: bold;
			margin-left: 5px;
			margin-right: 5px;
		}

		svg {
			width: 20px;
			height: 20px;
		}

		.report {
			fill: rgb(0, 45, 77);
		}
	</style>
</head>

<body>
	<div class="send">
		<label for="username">Username: </label>
		<input type="text" name="username" id="username">
		<label for="message">Message: </label>
		<input type="text" name="message" id="message">
		<button id="send" disabled>Send</button>
	</div>
	<p id="notice" class="notice"></p>
	<div class="messages"></div>

	<script>
		let messageArray = [];
		let auth;
		let canSendMessages = false;
		const messages = document.querySelector('.messages');
		const sendButton = document.getElementById('send');

		function sendMessage() {
			if (!canSendMessages) {
				return;
			}

			const username = document.getElementById('username').value.trim();
			const message = document.getElementById('message').value.trim();

			if (!username || !message) {
				return;
			}

			const timestamp = new Date().toLocaleString();

			const payload = {
				type: 'adminMessage',
				auth: auth,
				message: {
					username: username,
					timestamp: timestamp,
					content: message,
				},
			};

			fetch('/api', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify(payload),
			});

			document.getElementById('message').value = '';
			init();
		}

		function getBadge(badge) {
			const badgeInfo = {
				'verified-bot': { emoji: 'ðŸ¤–', title: 'Verified Bot' },
				'admin': { emoji: 'ðŸ› ï¸', title: 'Admin' },
				'verified': { emoji: 'âœ…', title: 'Verified' },
				'manager': { emoji: 'ðŸ’¼', title: 'Admin Manager' },
				'verified-system': { emoji: 'âš™ï¸', title: 'Verified System' },
			};

			return badgeInfo[badge] || '';
		}

		function renderMessages() {
			messages.innerHTML = '';

			messageArray.forEach(message => {
				const username = message.username + message.badges.map(getBadge).map(({ emoji, title }) => ` <span title="${title}">${emoji}</span>`).join('');

				const messageHTML = `<div class="message"><button title="Report Message" class="message-controls report" onclick="report('${message.id}', window.prompt('Enter Reason for reporting:'))"><svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M64 32C64 14.3 49.7 0 32 0S0 14.3 0 32V64 368 480c0 17.7 14.3 32 32 32s32-14.3 32-32V352l64.3-16.1c41.1-10.3 84.6-5.5 122.5 13.4c44.2 22.1 95.5 24.8 141.7 7.4l34.7-13c12.5-4.7 20.8-16.6 20.8-30V66.1c0-23-24.2-38-44.8-27.7l-9.6 4.8c-46.3 23.2-100.8 23.2-147.1 0c-35.1-17.6-75.4-22-113.5-12.5L64 48V32z"/></svg></button><i>${message.timestamp}</i> <b>${username}</b>: ${message.content}</div>`;
				messages.innerHTML = messageHTML + messages.innerHTML;
			});
		}

		function report(id, reason) {
			fetch('/api', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({
					type: 'postReport',
					id: id,
					reason: reason,
				})
			});
		}

		function init() {
			fetch('/api', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({
					type: 'checkKilled',
				}),
			})
				.then(res => res.json())
				.then(data => {
					if (data.killed) {
						window.location.reload();
					}
				});

			fetch('/api', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({
					type: 'getMessages',
				}),
			})
				.then(res => res.json())
				.then(data => {
					if (JSON.stringify(messageArray) === JSON.stringify(data.messages)) {
						return;
					}

					messageArray = data.messages;
					renderMessages();
				});

			fetch('/api', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({
					type: 'getMessage',
				}),
			})
				.then(res => res.json())
				.then(data => {
					document.getElementById('notice').innerHTML = data.message;
				});
		}

		function authInit() {
			auth = window.prompt("Enter Authentication Password for Admin Portal: ");

			fetch('/api', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({
					type: 'checkAdminAuthCorrect',
					auth: auth,
				}),
			})
				.then(res => res.json())
				.then(data => {
					if (data.correct) {
						canSendMessages = true;
						sendButton.disabled = false;
					} else {
						window.alert('Incorrect Authentication for Admin Portal');
						window.location.href = "https://digit.fifly.org";
					}
				});
		}

		document.addEventListener('DOMContentLoaded', () => {
			authInit();

			document.getElementById('send').addEventListener('click', () => {
				sendMessage();
			});

			document.addEventListener('keypress', (ev) => {
				if (ev.key == "Enter") {
					sendMessage();
				}
			});

			setInterval(init, 100);
		});
	</script>

</body>

</html>